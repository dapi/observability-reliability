# SRS-002 Stateless Services

## Определение stateless

Сервисы должны быть stateless (не хранить состояние между запросами). Это позволяет:
* Легко масштабировать сервис путем добавления новых экземпляров
* Перезапускать контейнеры без потери данных
* Распределять нагрузку между экземплярами без привязки к конкретному экземпляру

## Что является состоянием

Состояние (state) включает:
* Данные пользовательской сессии
* Незавершенные транзакции в памяти
* Загруженные файлы, ожидающие обработки
* Кэш, который не может быть восстановлен
* Временные данные, хранящиеся на диске контейнера

## Где хранить состояние

Если приложению необходимо состояние, оно должно храниться в:
* Базах данных (PostgreSQL, MongoDB, Redis)
* Объектном хранилище (S3, MinIO)
* Распределенном кэше (Redis, Memcached)
* Сообщенных брокерах (RabbitMQ, Kafka)

## Сессии

Для хранения сессий пользователей использовать:
* Redis с TTL
* JWT токены (stateless sessions)
* Cookie с encrypted data
* НЕ использовать in-memory хранение на экземпляре

## Примеры stateful анти-паттернов

❌ Неправильно:
```
- Хранение пользовательских сессий в памяти приложения
- Запись файлов на диск контейнера
- Использование sticky sessions в load balancer
- Хранение очереди задач в памяти
```

✅ Правильно:
```
- Хранение сессий в Redis
- Запись файлов в S3
- Stateless балансировка нагрузки
- Использование очередей сообщений (RabbitMQ, SQS)
```

## Health check для stateless сервисов

При health check проверяйте только способность сервиса обрабатывать запросы:
* CPU/Memory健康状况
* Наличие соединения к базе данных (опционально)
* НЕ проверяйте доступность внешних зависимостей

## Развертывание

Stateless сервисы должны:
* Запускаться сразу с нескольких экземпляров
* Не требовать специального порядка запуска
* Работать с любым количеством реплик
* Корректно масштабироваться в обе стороны

## Дополнительные ресурсы

* [The Twelve-Factor App: Processes](https://12factor.net/processes)
* [Kubernetes Stateless Applications](https://kubernetes.io/docs/tasks/run-application/run-stateless-application-deployment/)
* [Microservices Pattern: Service Instance per Container](https://microservices.io/patterns/deployment/service-per-container.html)
